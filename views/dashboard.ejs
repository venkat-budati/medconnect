
<!-- Dashboard Content -->
<main class="main-content">
        <!-- Welcome Banner -->
        <div class="welcome-card">
            <div class="welcome-content">
                <h2>Welcome back, <%= user.firstName || user.email.split('@')[0] %>!</h2>
                <p>You're making a difference by helping reduce medical waste and providing essential medicines to those in need. Keep up the great work!</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon-card icon-donate">
                    <i class="fas fa-pills"></i>
                </div>
                <div class="stat-details">
                    <div class="stat-number"><%= stats.medicinesDonated %></div>
                    <div class="stat-title">Medicines Donated</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon-card icon-receive">
                    <i class="fas fa-hand-holding-medical"></i>
                </div>
                <div class="stat-details">
                    <div class="stat-number"><%= stats.medicinesReceived %></div>
                    <div class="stat-title">Medicines Received</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon-card icon-pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-details">
                    <div class="stat-number"><%= stats.pendingRequests %></div>
                    <div class="stat-title">Pending Requests</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon-card icon-people">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-details">
                    <div class="stat-number"><%= stats.peopleHelped %></div>
                    <div class="stat-title">People Helped</div>
                </div>
            </div>
        </div>

        <!-- Medicines Donated Section -->
        <div class="content-section">
            <div class="section-header">
                <h3 class="section-title">Medicines You've Donated</h3>
                <a href="/dashboard/donor" class="view-all">View All <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="medicines-grid">
                <% if (recentDonations && recentDonations.length > 0) { %>
                    <% recentDonations.forEach(donation => { %>
                        <div class="medicine-card">
                            <div class="medicine-image">
                                <% if (donation.imageUrl) { %>
                                    <img src="<%= donation.imageUrl %>" alt="<%= donation.name %>">
                                <% } else { %>
                                    <i class="fas fa-capsules"></i>
                                <% } %>
                                <div class="medicine-status status-<%= donation.status.toLowerCase() %>"><%= donation.status %></div>
                            </div>
                            <div class="medicine-details">
                                <h4 class="medicine-name"><%= donation.name %></h4>
                                <div class="medicine-info">
                                    <div class="medicine-quantity">
                                        <i class="fas fa-capsules"></i> <%= donation.quantity %> <%= donation.unit || 'tablets' %>
                                    </div>
                                    <div class="medicine-expiry">
                                        <i class="fas fa-calendar"></i> <%= new Date(donation.expiry).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' }) %>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="action-button btn-details" onclick="viewMedicineDetails('<%= donation._id %>')">Details</button>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="empty-state" style="grid-column: 1 / -1; grid-row: 1 / -1;">
                        <i class="fas fa-pills"></i>
                        <h4>No donations yet</h4>
                        <p>Start helping others by donating your unused medicines.</p>
                        <a href="/donate" class="btn btn-primary">Donate Medicine</a>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Requests Section -->
        <div class="content-section">
            <div class="section-header">
                <h3 class="section-title">Your Medicine Requests</h3>
                <a href="/dashboard/requests" class="view-all">View All <i class="fas fa-arrow-right"></i></a>
            </div>
            <% if (recentRequests && recentRequests.length > 0) { %>
                <table class="requests-table">
                    <thead>
                        <tr>
                            <th>Medicine</th>
                            <th>Quantity</th>
                            <th>Date Requested</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% recentRequests.forEach(request => { %>
                            <tr class="table-row">
                                <td>
                                    <div class="medicine-cell">
                                        <div class="table-med-image">
                                            <% if (request.medicine && request.medicine.imageUrl) { %>
                                                <img src="<%= request.medicine.imageUrl %>" alt="<%= request.medicine.name %>">
                                            <% } else { %>
                                                <i class="fas fa-pills"></i>
                                            <% } %>
                                        </div>
                                        <div>
                                            <div class="medicine-name"><%= request.medicine ? request.medicine.name : 'Medicine' %></div>
                                            <div class="medicine-expiry">
                                                Exp: <%= request.medicine ? new Date(request.medicine.expiry).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'N/A' %>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td><%= request.quantity %> <%= request.medicine ? (request.medicine.unit || 'tablets') : 'units' %></td>
                                <td><%= new Date(request.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></td>
                                <td><span class="status-badge status-<%= request.status.toLowerCase() %>"><%= request.status %></span></td>
                                <td>
                                    <button class="action-button btn-details" onclick="viewRequestDetails('<%= request._id %>')">
                                        <% if (request.status === 'Pending') { %>
                                            Details
                                        <% } else if (request.status === 'Accepted') { %>
                                            Track
                                        <% } else if (request.status === 'Completed') { %>
                                            Review
                                        <% } else { %>
                                            Details
                                        <% } %>
                                    </button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } else { %>
                <div class="empty-state">
                    <i class="fas fa-hand-holding-medical"></i>
                    <h4>No requests yet</h4>
                    <p>Browse available medicines and make your first request.</p>
                    <a href="/dashboard/browse" class="btn btn-primary">Browse Medicines</a>
                </div>
            <% } %>
        </div>

        <!-- Expiring Medicines Alert -->
        <% if (expiringMedicines && expiringMedicines.length > 0) { %>
            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">⚠️ Expiring Soon</h3>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="alert-content">
                        <h4>Medicines Expiring Soon</h4>
                        <p>You have <%= expiringMedicines.length %> medicine(s) expiring within 30 days. Consider donating them before they expire.</p>
                        <div class="expiring-list">
                            <% expiringMedicines.forEach(medicine => { %>
                                <div class="expiring-item">
                                    <strong><%= medicine.name %></strong> - 
                                    Expires: <%= new Date(medicine.expiry).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                </div>
            </div>
        <% } %>
    </main>

<!-- Medicine Details Modal -->
<div id="medicineDetailsModal" class="medicine-details-modal-overlay" style="display: none;">
    <div class="medicine-details-modal-content">
        <div class="medicine-details-modal-header">
            <h3><i class="fas fa-pills"></i> Medicine Details</h3>
            <button class="medicine-details-modal-close" id="medicineModalClose">&times;</button>
        </div>
        <div class="medicine-details-modal-body" id="medicineDetailsContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<!-- Request Details Modal -->
<div id="requestDetailsModal" class="request-details-modal-overlay" style="display: none;">
    <div class="request-details-modal-content">
        <div class="request-details-modal-header">
            <h3><i class="fas fa-hand-holding-medical"></i> Request Details</h3>
            <button class="request-details-modal-close" id="requestModalClose">&times;</button>
        </div>
        <div class="request-details-modal-body" id="requestDetailsContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<style>
    /* Medicine Details Modal Styles */
    .medicine-details-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
    }

    .medicine-details-modal-content {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: medicineDetailsModalSlideIn 0.3s ease-out;
    }

    @keyframes medicineDetailsModalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .medicine-details-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e1e5e9;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px 16px 0 0;
    }

    .medicine-details-modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .medicine-details-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .medicine-details-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .medicine-details-modal-body {
        padding: 30px 24px;
    }

    /* Request Details Modal Styles */
    .request-details-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
    }

    .request-details-modal-content {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: requestDetailsModalSlideIn 0.3s ease-out;
    }

    @keyframes requestDetailsModalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .request-details-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e1e5e9;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 16px 16px 0 0;
    }

    .request-details-modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .request-details-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .request-details-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .request-details-modal-body {
        padding: 30px 24px;
    }

    /* Modal Content Styles */
    .medicine-details-display,
    .request-details-display {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .medicine-details-image {
        text-align: center;
        margin-bottom: 20px;
    }

    .medicine-details-image img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .medicine-details-image i {
        font-size: 80px;
        color: #667eea;
        opacity: 0.7;
    }

    .medicine-details-info h4,
    .request-details-info h4 {
        margin: 0 0 15px 0;
        font-size: 20px;
        font-weight: 600;
        color: #333;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .detail-item i {
        color: #667eea;
        width: 20px;
        text-align: center;
    }

    .detail-item span {
        color: #555;
        font-weight: 500;
    }

    /* Responsive Design */
    @media (max-width: 600px) {
        .medicine-details-modal-content,
        .request-details-modal-content {
            width: 95%;
            margin: 20px;
        }

        .medicine-details-modal-header,
        .request-details-modal-header {
            padding: 16px 20px;
        }

        .medicine-details-modal-body,
        .request-details-modal-body {
            padding: 24px 20px;
        }
    }
</style>

<script>
    // Dashboard interactions
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle active state for nav items
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                navItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Card hover animations
        const cards = document.querySelectorAll('.stat-card, .medicine-card');
        cards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-8px)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
        
        // Button interactions
        const buttons = document.querySelectorAll('.action-button, .donate-button');
        buttons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const text = this.textContent.toLowerCase();
                if(text.includes('donate')) {
                    window.location.href = '/donate';
                }
            });
        });
        
        // Notification bell - handled by dashboard layout
        // The notification functionality is already implemented in dashboard_layout.ejs
    });

    // Medicine and Request functions
    function viewMedicineDetails(medicineId) {
        // Show medicine details modal
        const modal = document.getElementById('medicineDetailsModal');
        const content = document.getElementById('medicineDetailsContent');
        
        // Find the donation data from the current page
        const donationCards = document.querySelectorAll('.medicine-card');
        let donationData = null;
        
        donationCards.forEach(card => {
            const detailsBtn = card.querySelector('.btn-details');
            if (detailsBtn && detailsBtn.getAttribute('onclick').includes(medicineId)) {
                const name = card.querySelector('.medicine-name').textContent;
                const quantity = card.querySelector('.medicine-quantity').textContent;
                const expiry = card.querySelector('.medicine-expiry').textContent;
                const status = card.querySelector('.medicine-status').textContent;
                const image = card.querySelector('.medicine-image img');
                const imageUrl = image ? image.src : null;
                
                donationData = {
                    name: name,
                    quantity: quantity,
                    expiry: expiry,
                    status: status,
                    imageUrl: imageUrl
                };
            }
        });
        
        if (donationData) {
            content.innerHTML = `
                <div class="medicine-details-display">
                    <div class="medicine-details-image">
                        ${donationData.imageUrl ? 
                            `<img src="${donationData.imageUrl}" alt="${donationData.name}">` : 
                            '<i class="fas fa-capsules"></i>'
                        }
                    </div>
                    <div class="medicine-details-info">
                        <h4>${donationData.name}</h4>
                        <div class="detail-item">
                            <i class="fas fa-capsules"></i>
                            <span>${donationData.quantity}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <span>${donationData.expiry}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-info-circle"></i>
                            <span>Status: ${donationData.status}</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            content.innerHTML = '<p>Medicine details not found.</p>';
        }
        
        openModal(modal);
    }

    function viewRequestDetails(requestId) {
        // Show request details modal
        const modal = document.getElementById('requestDetailsModal');
        const content = document.getElementById('requestDetailsContent');
        
        // Find the request data from the current page
        const requestRows = document.querySelectorAll('.table-row');
        let requestData = null;
        
        requestRows.forEach(row => {
            const detailsBtn = row.querySelector('.btn-details');
            if (detailsBtn && detailsBtn.getAttribute('onclick').includes(requestId)) {
                const medicineName = row.querySelector('.medicine-name').textContent;
                const quantity = row.querySelector('td:nth-child(2)').textContent;
                const dateRequested = row.querySelector('td:nth-child(3)').textContent;
                const status = row.querySelector('.status-badge').textContent;
                
                requestData = {
                    medicineName: medicineName,
                    quantity: quantity,
                    dateRequested: dateRequested,
                    status: status
                };
            }
        });
        
        if (requestData) {
            content.innerHTML = `
                <div class="request-details-display">
                    <div class="request-details-info">
                        <h4>${requestData.medicineName}</h4>
                        <div class="detail-item">
                            <i class="fas fa-capsules"></i>
                            <span>Quantity: ${requestData.quantity}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <span>Requested: ${requestData.dateRequested}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-info-circle"></i>
                            <span>Status: ${requestData.status}</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            content.innerHTML = '<p>Request details not found.</p>';
        }
        
        openModal(modal);
    }

    // Modal close functionality
    document.addEventListener('DOMContentLoaded', function() {
        let bodyScrollTop = 0;
        
        // Function to open modal
        function openModal(modal) {
            bodyScrollTop = window.pageYOffset || document.documentElement.scrollTop;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.top = `-${bodyScrollTop}px`;
            document.body.style.width = '100%';
        }
        
        // Function to close modal
        function closeModal(modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            window.scrollTo(0, bodyScrollTop);
        }
        
        // Medicine modal close
        const medicineModalClose = document.getElementById('medicineModalClose');
        const medicineModal = document.getElementById('medicineDetailsModal');
        
        if (medicineModalClose) {
            medicineModalClose.addEventListener('click', function() {
                closeModal(medicineModal);
            });
        }
        
        if (medicineModal) {
            medicineModal.addEventListener('click', function(e) {
                if (e.target === medicineModal) {
                    closeModal(medicineModal);
                }
            });
        }
        
        // Request modal close
        const requestModalClose = document.getElementById('requestModalClose');
        const requestModal = document.getElementById('requestDetailsModal');
        
        if (requestModalClose) {
            requestModalClose.addEventListener('click', function() {
                closeModal(requestModal);
            });
        }
        
        if (requestModal) {
            requestModal.addEventListener('click', function(e) {
                if (e.target === requestModal) {
                    closeModal(requestModal);
                }
            });
        }
    });
</script>