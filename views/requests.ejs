<link rel="stylesheet" href="/css/requests.css">
<!-- My Requests Section -->
<div class="main-content">
    <div class="requests-container">
        <!-- Section Header -->
        <div class="section-header">
            <div>
                <h2 class="section-title">My Medicine Requests</h2>
                <p class="section-subtitle">Track the status of medicines you've requested from others</p>
            </div>
            <div class="results-count" id="resultsCount">Loading...</div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tab active" data-status="all">All Requests</div>
            <div class="tab" data-status="Pending">Pending</div>
            <div class="tab" data-status="Accepted">Accepted</div>
            <div class="tab" data-status="Rejected">Rejected</div>
            <div class="tab" data-status="Completed">Completed</div>
        </div>
        
        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>Loading your requests...</p>
        </div>
        
        <!-- Requests Table -->
        <div class="requests-table-container" id="requestsTableContainer" style="display: none;">
            <table class="requests-table">
                <thead>
                    <tr>
                        <th>Medicine</th>
                        <th>Requested Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="requestsTableBody">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <h3>No requests found</h3>
            <p>You haven't made any medicine requests yet.</p>
            <button class="browse-button" onclick="window.location.href='/dashboard/browse'">
                <i class="fas fa-search"></i>
                Browse Medicines
            </button>
        </div>
        
        <!-- Error State -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Error loading requests</h3>
            <p id="errorMessage">Something went wrong while loading your requests.</p>
            <button class="retry-button" onclick="loadRequests()">
                <i class="fas fa-redo"></i>
                Try Again
            </button>
        </div>
    </div>
    
    <!-- Request Details Modal -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Request Details</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="medicine-details">
                    <div class="medicine-image">
                        <i class="fas fa-capsules" id="medIcon"></i>
                    </div>
                    <div class="medicine-info">
                        <h4 id="medName">Medicine Name</h4>
                        <p id="medDescription">Description</p>
                        <p><strong>Manufacturer:</strong> <span id="medManufacturer">-</span></p>
                        <p><strong>Quantity:</strong> <span id="medQuantity">-</span></p>
                        <p><strong>Expiry:</strong> <span id="medExpiry">-</span></p>
                    </div>
                </div>
                <div class="donor-details">
                    <h4>Donor Information</h4>
                    <p><strong>Name:</strong> <span id="donorName">-</span></p>
                    <p><strong>Location:</strong> <span id="donorLocation">-</span></p>
                </div>
                <div class="request-details">
                    <h4>Request Information</h4>
                    <p><strong>Status:</strong> <span id="requestStatus">-</span></p>
                    <p><strong>Requested Date:</strong> <span id="requestDate">-</span></p>
                    <p><strong>Your Message:</strong> <span id="requestMessage">-</span></p>
                    <div id="donorResponse" style="display: none;">
                        <p><strong>Donor's Response:</strong> <span id="donorResponseMessage">-</span></p>
                        <p><strong>Response Date:</strong> <span id="donorResponseDate">-</span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="closeModalBtn">Close</button>
                <button class="btn-danger" id="cancelRequestBtn" style="display: none;">Cancel Request</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentRequests = [];
    let currentStatus = 'all';
    
    // Load requests on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadRequests();
        setupEventListeners();
    });
    
    function loadRequests() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const requestsTableContainer = document.getElementById('requestsTableContainer');
        const emptyState = document.getElementById('emptyState');
        const errorState = document.getElementById('errorState');
        
        // Show loading
        loadingSpinner.style.display = 'flex';
        requestsTableContainer.style.display = 'none';
        emptyState.style.display = 'none';
        errorState.style.display = 'none';
        
        // Fetch requests from API
        fetch('/dashboard/requests/api')
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    currentRequests = data.requests;
                    renderRequests();
                } else {
                    showError(data.error || 'Failed to load requests');
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                showError('Network error: ' + error.message);
            });
    }
    
    function renderRequests() {
        const requestsTableBody = document.getElementById('requestsTableBody');
        const resultsCount = document.getElementById('resultsCount');
        const requestsTableContainer = document.getElementById('requestsTableContainer');
        const emptyState = document.getElementById('emptyState');
        
        // Filter requests by status
        let filteredRequests = currentRequests;
        if (currentStatus !== 'all') {
            filteredRequests = currentRequests.filter(req => req.status === currentStatus);
        }
        
        // Update results count
        resultsCount.textContent = `${filteredRequests.length} request${filteredRequests.length !== 1 ? 's' : ''}`;
        
        if (filteredRequests.length === 0) {
            requestsTableContainer.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        // Render requests
        requestsTableBody.innerHTML = filteredRequests.map(request => `
            <tr class="table-row" data-request-id="${request._id}">
                <td>
                    <div class="medicine-cell">
                        <div class="table-med-image">
                            <i class="fas fa-capsules"></i>
                        </div>
                        <div class="medicine-info">
                            <div class="medicine-name">${request.medicine.name}</div>
                            <div class="medicine-donor">
                                <i class="fas fa-user"></i>
                                <span>Donated by: ${request.donor.firstName} ${request.donor.lastName}</span>
                            </div>
                        </div>
                    </div>
                </td>
                <td>${formatDate(request.createdAt)}</td>
                <td><span class="status-badge status-${request.status.toLowerCase()}">${request.status}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="action-button btn-details view-details" data-request-id="${request._id}">
                            View Details
                        </button>
                        ${request.status === 'Pending' ? `
                            <button class="action-button btn-cancel" data-request-id="${request._id}">
                                Cancel
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `).join('');
        
        requestsTableContainer.style.display = 'block';
        emptyState.style.display = 'none';
        
        // Re-attach event listeners
        attachRowEventListeners();
    }
    
    function showError(message) {
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = message;
        errorState.style.display = 'block';
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }
    
    function setupEventListeners() {
        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentStatus = this.getAttribute('data-status');
                renderRequests();
            });
        });
        
        // Modal event listeners
        const modal = document.getElementById('requestModal');
        const closeModal = document.getElementById('closeModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        
        closeModal.addEventListener('click', closeModalFunc);
        closeModalBtn.addEventListener('click', closeModalFunc);
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModalFunc();
            }
        });
    }
    
    function attachRowEventListeners() {
        // View details buttons
        const viewButtons = document.querySelectorAll('.view-details');
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                openRequestModal(requestId);
            });
        });
        
        // Cancel buttons
        const cancelButtons = document.querySelectorAll('.btn-cancel');
        cancelButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                cancelRequest(requestId);
            });
        });
    }
    
    function openRequestModal(requestId) {
        const request = currentRequests.find(req => req._id === requestId);
        if (!request) return;
        
        // Populate modal with request data
        document.getElementById('medName').textContent = request.medicine.name;
        document.getElementById('medDescription').textContent = request.medicine.description || 'No description available';
        document.getElementById('medManufacturer').textContent = request.medicine.manufacturer || 'Unknown';
        document.getElementById('medQuantity').textContent = request.quantity;
        document.getElementById('medExpiry').textContent = formatDate(request.medicine.expiry);
        document.getElementById('donorName').textContent = `${request.donor.firstName} ${request.donor.lastName}`;
        document.getElementById('donorLocation').textContent = `${request.donor.city}, ${request.donor.state}`;
        document.getElementById('requestStatus').textContent = request.status;
        document.getElementById('requestDate').textContent = formatDate(request.createdAt);
        document.getElementById('requestMessage').textContent = request.message || 'No message provided';
        
        // Show/hide donor response
        const donorResponseDiv = document.getElementById('donorResponse');
        if (request.donorResponse && request.donorResponse.message) {
            document.getElementById('donorResponseMessage').textContent = request.donorResponse.message;
            document.getElementById('donorResponseDate').textContent = formatDate(request.donorResponse.respondedAt);
            donorResponseDiv.style.display = 'block';
        } else {
            donorResponseDiv.style.display = 'none';
        }
        
        // Show/hide cancel button
        const cancelRequestBtn = document.getElementById('cancelRequestBtn');
        if (request.status === 'Pending') {
            cancelRequestBtn.style.display = 'inline-block';
            cancelRequestBtn.setAttribute('data-request-id', requestId);
        } else {
            cancelRequestBtn.style.display = 'none';
        }
        
        // Show modal
        document.getElementById('requestModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closeModalFunc() {
        document.getElementById('requestModal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    function cancelRequest(requestId) {
        const request = currentRequests.find(req => req._id === requestId);
        if (!request) return;
        
        if (confirm(`Are you sure you want to cancel your request for ${request.medicine.name}?`)) {
            // Send cancel request to API
            fetch(`/dashboard/requests/${requestId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove from current requests
                    currentRequests = currentRequests.filter(req => req._id !== requestId);
                    renderRequests();
                    showNotification('Request cancelled successfully', 'success');
                } else {
                    showNotification(data.error || 'Failed to cancel request', 'error');
                }
            })
            .catch(error => {
                showNotification('Network error: ' + error.message, 'error');
            });
        }
    }
    
    // Cancel request from modal
    document.getElementById('cancelRequestBtn').addEventListener('click', function() {
        const requestId = this.getAttribute('data-request-id');
        closeModalFunc();
        cancelRequest(requestId);
    });
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
</script>