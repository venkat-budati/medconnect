<link rel="stylesheet" href="/css/requests.css">
<!-- My Requests Section -->
<div class="main-content">
    <div class="requests-container">
        <!-- Section Header -->
        <div class="section-header">
            <div>
                <h2 class="section-title">My Medicine Requests</h2>
                <p class="section-subtitle">Track the status of medicines you've requested from others</p>
            </div>
            <div class="results-count" id="resultsCount">Loading...</div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tab active" data-status="all">All Requests</div>
            <div class="tab" data-status="Pending">Pending</div>
            <div class="tab" data-status="Accepted">Accepted</div>
            <div class="tab" data-status="Rejected">Rejected</div>
            <div class="tab" data-status="Completed">Completed</div>
        </div>
        
        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>Loading your requests...</p>
        </div>
        
        <!-- Requests Table -->
        <div class="requests-table-container" id="requestsTableContainer" style="display: none;">
            <table class="requests-table">
                <thead>
                    <tr>
                        <th>Medicine</th>
                        <th>Requested Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="requestsTableBody">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <h3>No requests found</h3>
        </div>
        
        <!-- Error State -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Error loading requests</h3>
            <p id="errorMessage">Something went wrong while loading your requests.</p>
            <button class="retry-button" onclick="loadRequests()">
                <i class="fas fa-redo"></i>
                Try Again
            </button>
        </div>
    </div>
    
    <!-- Enhanced Request Details Modal -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="fas fa-file-medical"></i>
                    </div>
                    <div class="header-text">
                        <h3>Request Details</h3>
                        <p class="header-subtitle">View complete information about your medicine request</p>
                    </div>
                </div>
                <button class="close-modal" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Medicine Information Section -->
                <div class="detail-section medicine-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-capsules"></i>
                        </div>
                        <h4>Medicine Information</h4>
                    </div>
                    <div class="section-content">
                        <div class="medicine-card">
                            <div class="medicine-image">
                                <img id="medImage" src="" alt="Medicine" style="width: 100%; height: 100%; object-fit: cover; border-radius: 20px;">
                                <i class="fas fa-capsules" id="medIcon" style="display: none;"></i>
                            </div>
                            <div class="medicine-details">
                                <h5 id="medName">Medicine Name</h5>
                                <p class="medicine-description" id="medDescription">Description</p>
                                <div class="medicine-specs">
                                    <div class="spec-item">
                                        <i class="fas fa-industry"></i>
                                        <span><strong>Manufacturer:</strong> <span id="medManufacturer">-</span></span>
                                    </div>
                                    <div class="spec-item">
                                        <i class="fas fa-calculator"></i>
                                        <span><strong>Quantity:</strong> <span id="medQuantity">-</span></span>
                                    </div>
                                    <div class="spec-item">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span><strong>Expiry:</strong> <span id="medExpiry">-</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Donor Information Section -->
                <div class="detail-section donor-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <h4>Donor Information</h4>
                    </div>
                    <div class="section-content">
                        <div class="donor-card">
                            <div class="donor-avatar">
                                <img id="donorImage" src="" alt="Donor" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                <i class="fas fa-user" style="display: none;"></i>
                            </div>
                            <div class="donor-info">
                                <h5 id="donorName">Donor Name</h5>
                                <div class="donor-location">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span id="donorLocation">Location</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Request Information Section -->
                <div class="detail-section request-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <h4>Request Information</h4>
                    </div>
                    <div class="section-content">
                        <div class="request-info-grid">
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-calendar"></i>
                                    <span>Request Date</span>
                                </div>
                                <div class="info-value" id="requestDate">-</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Status</span>
                                </div>
                                <div class="info-value" id="requestStatus">-</div>
                            </div>
                            <div class="info-item full-width">
                                <div class="info-label">
                                    <i class="fas fa-comment"></i>
                                    <span>Your Message</span>
                                </div>
                                <div class="message-content" id="requestMessage">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Donor Response Section (if available) -->
                <div class="detail-section donor-response-section" id="donorResponse" style="display: none;">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-reply"></i>
                        </div>
                        <h4>Donor Response</h4>
                    </div>
                    <div class="section-content">
                        <div class="response-header">
                            <i class="fas fa-user-circle"></i>
                            <h5>Response from Donor</h5>
                        </div>
                        <div class="response-message" id="donorResponseMessage">-</div>
                        <div class="response-date" id="donorResponseDate">-</div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModalFunc()">Close</button>
                <button class="btn-danger" id="cancelRequestBtn" style="display: none;">Cancel Request</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Request Cancellation -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content confirmation-modal">
            <div class="modal-header">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="header-text">
                        <h3>Confirm Cancellation</h3>
                        <p class="header-subtitle">Are you sure you want to cancel this request?</p>
                    </div>
                </div>
                <button class="close-modal" onclick="closeConfirmationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="confirmation-content">
                    <p>This action cannot be undone. The request will be permanently cancelled.</p>
                    <div class="request-summary" id="confirmationRequestSummary">
                        <!-- Request details will be populated here -->
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeConfirmationModal()">Keep Request</button>
                <button class="btn-danger" id="confirmCancelBtn">Yes, Cancel Request</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentRequests = [];
    let currentStatus = 'all';
    
    // Load requests on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadRequests();
        setupEventListeners();
    });
    
    function loadRequests() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const requestsTableContainer = document.getElementById('requestsTableContainer');
        const emptyState = document.getElementById('emptyState');
        const errorState = document.getElementById('errorState');
        
        // Show loading
        loadingSpinner.style.display = 'flex';
        requestsTableContainer.style.display = 'none';
        emptyState.style.display = 'none';
        errorState.style.display = 'none';
        
        // Fetch requests from API
        fetch('/dashboard/requests/api')
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    currentRequests = data.requests;
                    renderRequests();
                } else {
                    showError(data.error || 'Failed to load requests');
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                showError('Network error: ' + error.message);
            });
    }
    
    function renderRequests() {
        const requestsTableBody = document.getElementById('requestsTableBody');
        const resultsCount = document.getElementById('resultsCount');
        const requestsTableContainer = document.getElementById('requestsTableContainer');
        const emptyState = document.getElementById('emptyState');
        
        // Filter requests by status
        let filteredRequests = currentRequests;
        if (currentStatus !== 'all') {
            filteredRequests = currentRequests.filter(req => req.status === currentStatus);
        }
        
        // Update results count
        resultsCount.textContent = `${filteredRequests.length} request${filteredRequests.length !== 1 ? 's' : ''}`;
        
        if (filteredRequests.length === 0) {
            requestsTableContainer.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        // Render requests
        requestsTableBody.innerHTML = filteredRequests.map(request => `
            <tr class="table-row" data-request-id="${request._id}">
                <td>
                    <div class="medicine-cell">
                        <div class="table-med-image">
                            <i class="fas fa-capsules"></i>
                        </div>
                        <div class="medicine-info" style="gap: 0px; display: flex; flex-direction: column; margin-bottom: 0px;height: 100%; align-items: flex-start;">
                            <div class="medicine-name">${request.medicine.name}</div>
                            <div class="medicine-donor">
                                <i class="fas fa-user"></i>
                                <span>Donated by: ${request.donor.firstName} ${request.donor.lastName}</span>
                            </div>
                        </div>
                    </div>
                </td>
                <td>${formatDate(request.createdAt)}</td>
                <td><span class="status-badge status-${request.status.toLowerCase()}">${request.status}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="action-button btn-details view-details" data-request-id="${request._id}">
                            View Details
                        </button>
                        ${request.status === 'Pending' ? `
                            <button class="action-button btn-cancel" data-request-id="${request._id}">
                                Cancel
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `).join('');
        
        requestsTableContainer.style.display = 'block';
        emptyState.style.display = 'none';
        
        // Re-attach event listeners
        attachRowEventListeners();
    }
    
    function showError(message) {
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = message;
        errorState.style.display = 'block';
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }
    
    function setupEventListeners() {
        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentStatus = this.getAttribute('data-status');
                renderRequests();
            });
        });
        
        // Modal event listeners
        const modal = document.getElementById('requestModal');
        const closeModal = document.getElementById('closeModal');
        const closeModalBtn = document.getElementById('closeModalBtn'); // This line is removed as per new_code
        
        closeModal.addEventListener('click', closeModalFunc);
        // closeModalBtn.addEventListener('click', closeModalFunc); // This line is removed as per new_code
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModalFunc();
            }
        });

        // Confirmation modal event listeners
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');

        confirmCancelBtn.addEventListener('click', function() {
            const requestId = this.getAttribute('data-request-id');
            if (requestId) {
                cancelRequest(requestId);
            }
            closeConfirmationModal();
        });

        confirmationModal.addEventListener('click', function(e) {
            if (e.target === confirmationModal) {
                closeConfirmationModal();
            }
        });
    }
    
    function attachRowEventListeners() {
        // View details buttons
        const viewButtons = document.querySelectorAll('.view-details');
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                openRequestModal(requestId);
            });
        });
        
        // Cancel buttons
        const cancelButtons = document.querySelectorAll('.btn-cancel');
        cancelButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                openConfirmationModal(requestId);
            });
        });
    }
    
    function openRequestModal(requestId) {
        const request = currentRequests.find(req => req._id === requestId);
        if (!request) return;
        
        // Populate modal with request data
        document.getElementById('medName').textContent = request.medicine.name;
        document.getElementById('medDescription').textContent = request.medicine.description || 'No description available';
        document.getElementById('medManufacturer').textContent = request.medicine.manufacturer || 'Unknown';
        document.getElementById('medQuantity').textContent = request.quantity;
        document.getElementById('medExpiry').textContent = formatDate(request.medicine.expiry);
        document.getElementById('donorName').textContent = `${request.donor.firstName} ${request.donor.lastName}`;
        document.getElementById('donorLocation').textContent = `${request.donor.city}, ${request.donor.state}`;
        document.getElementById('requestStatus').textContent = request.status;
        document.getElementById('requestDate').textContent = formatDate(request.createdAt);
        document.getElementById('requestMessage').textContent = request.message || 'No message provided';
        
        // Handle medicine image
        const medImage = document.getElementById('medImage');
        const medIcon = document.getElementById('medIcon');
        if (request.medicine.imageUrl && request.medicine.imageUrl.trim() !== '') {
            medImage.src = request.medicine.imageUrl;
            medImage.style.display = 'block';
            medIcon.style.display = 'none';
        } else {
            medImage.style.display = 'none';
            medIcon.style.display = 'block';
        }
        
        // Handle donor image
        const donorImage = document.getElementById('donorImage');
        const donorIcon = document.querySelector('.donor-avatar i');
        if (request.donor.profileImage && request.donor.profileImage.trim() !== '') {
            donorImage.src = request.donor.profileImage;
            donorImage.style.display = 'block';
            donorIcon.style.display = 'none';
        } else {
            donorImage.style.display = 'none';
            donorIcon.style.display = 'block';
        }
        
        // Show/hide donor response
        const donorResponseDiv = document.getElementById('donorResponse');
        if (request.donorResponse && request.donorResponse.message) {
            document.getElementById('donorResponseMessage').textContent = request.donorResponse.message;
            document.getElementById('donorResponseDate').textContent = formatDate(request.donorResponse.respondedAt);
            donorResponseDiv.style.display = 'block';
        } else {
            donorResponseDiv.style.display = 'none';
        }
        
        // Show/hide cancel button
        const cancelRequestBtn = document.getElementById('cancelRequestBtn');
        if (request.status === 'Pending') {
            cancelRequestBtn.style.display = 'inline-block';
            cancelRequestBtn.setAttribute('data-request-id', requestId);
        } else {
            cancelRequestBtn.style.display = 'none';
        }
        
        // Show modal
        document.getElementById('requestModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function openConfirmationModal(requestId) {
        const request = currentRequests.find(req => req._id === requestId);
        if (!request) return;

        const confirmationRequestSummary = document.getElementById('confirmationRequestSummary');
        confirmationRequestSummary.innerHTML = `
            <p><strong>Medicine:</strong> ${request.medicine.name}</p>
            <p><strong>Requested Date:</strong> ${formatDate(request.createdAt)}</p>
            <p><strong>Status:</strong> ${request.status}</p>
            <p><strong>Your Message:</strong> ${request.message || 'No message provided'}</p>
        `;
        document.getElementById('confirmCancelBtn').setAttribute('data-request-id', requestId);
        document.getElementById('confirmationModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeConfirmationModal() {
        document.getElementById('confirmationModal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    function closeModalFunc() {
        document.getElementById('requestModal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    function cancelRequest(requestId) {
        const request = currentRequests.find(req => req._id === requestId);
        if (!request) return;
        
        // Send cancel request to API
        fetch(`/dashboard/requests/${requestId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove from current requests
                currentRequests = currentRequests.filter(req => req._id !== requestId);
                renderRequests();
                closeConfirmationModal();
                showNotification('Request cancelled successfully', 'success');
            } else {
                showNotification(data.error || 'Failed to cancel request', 'error');
            }
        })
        .catch(error => {
            showNotification('Network error: ' + error.message, 'error');
        });
    }
    
    // Cancel request from modal
    document.getElementById('cancelRequestBtn').addEventListener('click', function() {
        const requestId = this.getAttribute('data-request-id');
        closeModalFunc();
        openConfirmationModal(requestId);
    });
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
</script>