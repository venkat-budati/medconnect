<% title = 'Browse Medicines - MedConnect' %>

<link rel="stylesheet" href="/css/browse.css">

<!-- Browse Medicines Section -->
<div class="main-content">
    <div class="browse-container">
        <!-- Browse Header -->
        <div class="browse-header">
            <div>
                <h2 class="browse-title">Browse Available Medicines</h2>
                <p class="browse-subtitle">Find medicines donated by others near you</p>
            </div>
            <div class="results-count"><%= medicines ? medicines.length : 0 %> available medicines</div>
        </div>
        
        <!-- Filters -->
        <div class="filters-container">
            <div class="filter-group">
                <label class="filter-label">Medicine Name</label>
                <input type="text" class="filter-input" id="searchFilter" placeholder="Search by name" value="<%= currentFilters.search || '' %>">
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Category</label>
                <select class="filter-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    <% if (categories) { %>
                        <% categories.forEach(category => { %>
                            <option value="<%= category %>" <%= currentFilters.category === category ? 'selected' : '' %>><%= category %></option>
                        <% }); %>
                    <% } %>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Distance</label>
                <div class="distance-filter-container">
                    <select class="filter-select" id="distanceFilter">
                        <option value="5" <%= currentFilters.distance === '5' ? 'selected' : '' %>>Within 5 km</option>
                        <option value="10" <%= currentFilters.distance === '10' ? 'selected' : '' %>>Within 10 km</option>
                        <option value="15" <%= currentFilters.distance === '15' ? 'selected' : '' %>>Within 15 km</option>
                        <option value="25" <%= currentFilters.distance === '25' ? 'selected' : '' %>>Within 25 km</option>
                        <option value="50" <%= currentFilters.distance === '50' ? 'selected' : '' %>>Within 50 km</option>
                        <option value="custom" <%= currentFilters.distance === 'custom' ? 'selected' : '' %>>Custom Distance</option>
                        <option value="all" <%= currentFilters.distance === 'all' ? 'selected' : '' %>>Any Distance</option>
                    </select>
                    <input type="number" class="filter-input custom-distance-input" id="customDistanceInput" 
                           placeholder="Enter km" min="1" max="1000" 
                           value="<%= currentFilters.customDistance || '' %>"
                           style="display: none;">
                </div>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Sort By</label>
                <select class="filter-select" id="sortFilter">
                    <option value="distance" <%= currentFilters.sort === 'distance' ? 'selected' : '' %>>Distance</option>
                    <option value="newest" <%= currentFilters.sort === 'newest' ? 'selected' : '' %>>Newest First</option>
                    <option value="oldest" <%= currentFilters.sort === 'oldest' ? 'selected' : '' %>>Oldest First</option>
                    <option value="expiry" <%= currentFilters.sort === 'expiry' ? 'selected' : '' %>>Expiry Date</option>
                    <option value="name" <%= currentFilters.sort === 'name' ? 'selected' : '' %>>Name A-Z</option>
                </select>
            </div>
        </div>
        
        <!-- Location Notice -->
        <% if (!userLocation) { %>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div class="alert-content">
                    <h4>Location Required</h4>
                    <p>To see distance-based results, please update your profile with your complete address.</p>
                    <a href="/dashboard/profile" class="btn btn-primary">Update Profile</a>
                </div>
            </div>
        <% } %>
        
        <!-- Medicines Grid -->
        <div class="medicines-grid" id="medicinesGrid">
            <% if (medicines && medicines.length > 0) { %>
                <% medicines.forEach(medicine => { %>
                    <div class="medicine-card">
                        <div class="medicine-image">
                            <% if (medicine.imageUrl) { %>
                                <img src="<%= medicine.imageUrl %>" alt="<%= medicine.name %>">
                            <% } else { %>
                                <div class="default-medicine-image" data-category="<%= medicine.category || 'general' %>">
                                    <i class="fas fa-capsules"></i>
                                    <div class="image-overlay">
                                        <span class="category-label"><%= medicine.category || 'Medicine' %></span>
                                    </div>
                                </div>
                            <% } %>
                            <div class="medicine-status status-<%= medicine.status.toLowerCase() %>"><%= medicine.status %></div>
                        </div>
                        <div class="medicine-details">
                            <h4 class="medicine-name"><%= medicine.name %></h4>
                            <div class="medicine-info">
                                <div class="info-item">
                                    <i class="fas fa-capsules"></i>
                                    <span><%= medicine.quantity %> <%= medicine.unit || 'tablets' %></span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>Expires: <%= new Date(medicine.expiry).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-user"></i>
                                    <span>Donated by: <%= medicine.donor ? (medicine.donor.firstName || medicine.donor.email.split('@')[0]) : 'Anonymous' %></span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span><%= medicine.donor ? `${medicine.donor.city || ''}, ${medicine.donor.state || ''}` : 'Location not available' %></span>
                                </div>
                                <% if (medicine.distanceFormatted) { %>
                                    <div class="distance-badge">
                                        <i class="fas fa-location-arrow"></i> <%= medicine.distanceFormatted %>
                                    </div>
                                <% } %>
                            </div>
                            <div class="card-actions">
                                <button class="action-button btn-details view-details" data-id="<%= medicine._id %>">
                                    View Details
                                </button>
                                <button class="action-button btn-request" onclick="requestMedicine('<%= medicine._id %>')">
                                    Request
                                </button>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="empty-state" style="grid-column: 1 / -1; grid-row: 1 / -1;">
                    <i class="fas fa-search"></i>
                    <h4>No medicines found</h4>
                    <p>Try adjusting your filters or check back later for new donations.</p>
                    <a href="/dashboard/browse" class="btn btn-primary">Clear Filters</a>
                </div>
            <% } %>
        </div>
    </div>
    
    <!-- Medicine Details Modal -->
    <div class="modal-overlay" id="medicineModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Medicine Details</h3>
                <button class="close-modal" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="modal-image-section">
                    <div class="modal-image-gallery" id="modalImageGallery">
                        <!-- Images will be dynamically inserted here -->
                    </div>
                    <div class="modal-image-nav">
                        <button class="image-nav-btn prev-btn" id="prevImageBtn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="image-nav-btn next-btn" id="nextImageBtn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="image-indicators" id="imageIndicators">
                        <!-- Indicators will be dynamically inserted here -->
                    </div>
                </div>
                <div class="modal-details">
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-capsules"></i> Medicine Name</span>
                        <span class="detail-value" id="medName"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-info-circle"></i> Description</span>
                        <span class="detail-value" id="medDesc"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-calculator"></i> Quantity</span>
                        <span class="detail-value" id="medQty"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-calendar"></i> Expiry Date</span>
                        <span class="detail-value" id="medExpiry"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-tag"></i> Category</span>
                        <span class="detail-value" id="medCategory"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-user"></i> Donated By</span>
                        <span class="detail-value" id="medDonor"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-map-marker-alt"></i> Pickup Location</span>
                        <div class="address-card">
                            <div class="detail-value" id="medAddress"></div>
                        </div>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-clock"></i> Donated On</span>
                        <span class="detail-value" id="medDonatedOn"></span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="closeModalBtn">
                    Close
                </button>
                <button class="action-button btn-request" id="modalRequestBtn">
                    Request This Medicine
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables and functions
        let medicines = [];
        let modal, closeModal, closeModalBtn;
        
        // Helper function to get medicine icon based on category
        function getMedicineIcon(category) {
            const iconMap = {
                'Pain Relief': 'fas fa-head-side-cough',
                'Fever': 'fas fa-thermometer-half',
                'Antibiotics': 'fas fa-shield-virus',
                'Vitamins': 'fas fa-apple-alt',
                'Diabetes': 'fas fa-tint',
                'Blood Pressure': 'fas fa-heartbeat',
                'Allergy': 'fas fa-wind',
                'Cough & Cold': 'fas fa-lungs',
                'Digestive': 'fas fa-stomach',
                'Skin Care': 'fas fa-spa',
                'Eye Care': 'fas fa-eye',
                'Dental': 'fas fa-tooth',
                'Women Health': 'fas fa-female',
                'Children': 'fas fa-baby',
                'Elderly': 'fas fa-user-plus',
                'First Aid': 'fas fa-first-aid',
                'General': 'fas fa-capsules'
            };
            
            return iconMap[category] || 'fas fa-capsules';
        }
        
        // Open modal function
        function openModal(medicineId) {
            const medicine = medicines.find(m => m._id === medicineId);
            if (!medicine) return;
            
            // Update modal content
            document.getElementById('medName').textContent = medicine.name;
            document.getElementById('medDesc').textContent = medicine.description || 'No description available';
            document.getElementById('medQty').textContent = `${medicine.quantity} ${medicine.unit || 'tablets'}`;
            document.getElementById('medExpiry').textContent = new Date(medicine.expiry).toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('medCategory').textContent = medicine.category || 'Uncategorized';
            document.getElementById('medDonor').textContent = medicine.donor ? 
                (medicine.donor.firstName || medicine.donor.email.split('@')[0]) : 'Anonymous';
            document.getElementById('medDonatedOn').textContent = new Date(medicine.createdAt).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Update modal image gallery
            updateModalImageGallery(medicine);
            
            // Address
            let address = 'Location not available';
            if (medicine.donor && medicine.donor.addressLine1) {
                address = `${medicine.donor.addressLine1}`;
                if (medicine.donor.city) address += `, ${medicine.donor.city}`;
                if (medicine.donor.state) address += `, ${medicine.donor.state}`;
                if (medicine.donor.pincode) address += ` ${medicine.donor.pincode}`;
            }
            document.getElementById('medAddress').textContent = address;
            
            // Set request button data
            document.getElementById('modalRequestBtn').setAttribute('data-id', medicineId);
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // Update modal image gallery
        function updateModalImageGallery(medicine) {
            const gallery = document.getElementById('modalImageGallery');
            const indicators = document.getElementById('imageIndicators');
            const prevBtn = document.getElementById('prevImageBtn');
            const nextBtn = document.getElementById('nextImageBtn');
            
            // Clear existing content
            gallery.innerHTML = '';
            indicators.innerHTML = '';
            
            // Get images (support for multiple images)
            const images = [];
            if (medicine.imageUrl) {
                // Split by comma if multiple images
                const imageUrls = medicine.imageUrl.split(',').map(url => url.trim());
                images.push(...imageUrls);
            }
            
            if (images.length === 0) {
                // Show default image with category-specific icon
                const icon = getMedicineIcon(medicine.category);
                gallery.innerHTML = `
                    <div class="modal-default-image">
                        <i class="${icon}"></i>
                        <div class="modal-image-overlay">
                            <span class="modal-category-label">${medicine.category || 'Medicine'}</span>
                        </div>
                    </div>
                `;
                
                // Hide navigation and indicators
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                indicators.style.display = 'none';
            } else {
                // Show images with navigation
                images.forEach((imageUrl, index) => {
                    const slide = document.createElement('div');
                    slide.className = `modal-image-slide ${index === 0 ? 'active' : ''}`;
                    slide.innerHTML = `<img src="${imageUrl}" alt="${medicine.name} - Image ${index + 1}">`;
                    gallery.appendChild(slide);
                    
                    // Create indicator
                    const indicator = document.createElement('div');
                    indicator.className = `image-indicator ${index === 0 ? 'active' : ''}`;
                    indicator.onclick = () => showImage(index);
                    indicators.appendChild(indicator);
                });
                
                // Show/hide navigation based on image count
                if (images.length > 1) {
                    prevBtn.style.display = 'flex';
                    nextBtn.style.display = 'flex';
                    indicators.style.display = 'flex';
                    
                    // Set up navigation
                    let currentImage = 0;
                    
                    prevBtn.onclick = () => {
                        currentImage = (currentImage - 1 + images.length) % images.length;
                        showImage(currentImage);
                    };
                    
                    nextBtn.onclick = () => {
                        currentImage = (currentImage + 1) % images.length;
                        showImage(currentImage);
                    };
                    
                    function showImage(index) {
                        // Hide all slides
                        document.querySelectorAll('.modal-image-slide').forEach(slide => {
                            slide.classList.remove('active');
                        });
                        
                        // Remove active from all indicators
                        document.querySelectorAll('.image-indicator').forEach(ind => {
                            ind.classList.remove('active');
                        });
                        
                        // Show selected slide and indicator
                        document.querySelectorAll('.modal-image-slide')[index].classList.add('active');
                        document.querySelectorAll('.image-indicator')[index].classList.add('active');
                        
                        currentImage = index;
                    }
                } else {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                    indicators.style.display = 'none';
                }
            }
        }
        
        // Close modal function
        function closeModalFunc() {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            modal = document.getElementById('medicineModal');
            closeModal = document.getElementById('closeModal');
            closeModalBtn = document.getElementById('closeModalBtn');
            const viewButtons = document.querySelectorAll('.btn-view');            
            // Medicine data from backend
            medicines = <%- JSON.stringify(medicines || []) %>;
            

            
            // Initial event listeners setup
            attachEventListeners();
            
            // Update default medicine images with category-specific icons
            function updateDefaultImages() {
                const defaultImages = document.querySelectorAll('.default-medicine-image');
                defaultImages.forEach(container => {
                    const category = container.getAttribute('data-category');
                    const icon = container.querySelector('i');
                    if (icon && category) {
                        const newIcon = getMedicineIcon(category);
                        icon.className = newIcon;
                    }
                });
            }
            
            // Initialize default images
            updateDefaultImages();
            
            // AJAX Filtering
            let filterTimeout;
            const searchFilter = document.getElementById('searchFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const distanceFilter = document.getElementById('distanceFilter');
            const customDistanceInput = document.getElementById('customDistanceInput');
            const sortFilter = document.getElementById('sortFilter');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const medicinesGrid = document.getElementById('medicinesGrid');
            const resultsCount = document.querySelector('.results-count');
            
            // Debounced search function
            function debounceSearch() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(applyFilters, 500);
            }
            
            // Apply filters function
            async function applyFilters() {
                const distanceFilterValue = distanceFilter.value;
                
                // Handle "Any Distance" - don't send distance filter
                const filters = {
                    search: searchFilter.value,
                    category: categoryFilter.value,
                    sort: sortFilter.value
                };
                
                // Handle distance filter
                if (distanceFilterValue === 'all') {
                    // Explicitly send "all" to indicate no distance filtering
                    filters.distance = 'all';
                } else if (distanceFilterValue === 'custom') {
                    filters.customDistance = customDistanceInput.value || '50';
                } else {
                    filters.distance = distanceFilterValue;
                }
                
                // Show loading state
                medicinesGrid.innerHTML = '<div class="loading-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary);"></i><p style="margin-top: 10px; color: var(--gray);">Loading medicines...</p></div>';
                
                try {
                    const queryString = new URLSearchParams(filters).toString();
                    console.log('📤 Sending filters:', filters);
                    console.log('📤 Query string:', queryString);
                    const response = await fetch(`/dashboard/browse?${queryString}`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('📊 Received medicines data:', data.medicines.length, 'medicines');
                        console.log('📊 Sample medicine:', data.medicines[0]);
                        updateMedicinesGrid(data.medicines);
                        updateResultsCount(data.medicines.length);
                    } else {
                        throw new Error('Failed to fetch medicines');
                    }
                } catch (error) {
                    console.error('Filter error:', error);
                    medicinesGrid.innerHTML = '<div class="error-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--accent);"><i class="fas fa-exclamation-triangle"></i><p style="margin-top: 10px;">Error loading medicines. Please try again.</p></div>';
                }
            }
            
            // Update medicines grid
            function updateMedicinesGrid(newMedicines) {
                // Update global medicines array
                medicines = newMedicines;
                
                if (!medicines || medicines.length === 0) {
                    medicinesGrid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1; grid-row: 1 / -1;">
                            <i class="fas fa-search"></i>
                            <h4>No medicines found</h4>
                            <p>Try adjusting your filters or check back later for new donations.</p>
                            <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
                        </div>
                    `;
                    return;
                }
                
                console.log('🔍 Rendering medicines:', medicines.length);
                medicines.forEach((medicine, index) => {
                    console.log(`🔍 Medicine ${index}:`, {
                        name: medicine.name,
                        distance: medicine.distance,
                        distanceFormatted: medicine.distanceFormatted,
                        hasDistance: !!medicine.distance,
                        hasDistanceFormatted: !!medicine.distanceFormatted
                    });
                });
                
                const medicinesHTML = medicines.map(medicine => `
                    <div class="medicine-card">
                        <div class="medicine-image">
                            ${medicine.imageUrl ? 
                                `<img src="${medicine.imageUrl}" alt="${medicine.name}">` : 
                                `<div class="default-medicine-image" data-category="${medicine.category || 'general'}">
                                    <i class="fas fa-capsules"></i>
                                    <div class="image-overlay">
                                        <span class="category-label">${medicine.category || 'Medicine'}</span>
                                    </div>
                                </div>`
                            }
                            <div class="medicine-status status-${medicine.status.toLowerCase()}">${medicine.status}</div>
                        </div>
                        <div class="medicine-details">
                            <h4 class="medicine-name">${medicine.name}</h4>
                            <div class="medicine-info">
                                <div class="info-item">
                                    <i class="fas fa-capsules"></i>
                                    <span>${medicine.quantity} ${medicine.unit || 'tablets'}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>Expires: ${new Date(medicine.expiry).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-user"></i>
                                    <span>Donated by: ${medicine.donor ? (medicine.donor.firstName || medicine.donor.email.split('@')[0]) : 'Anonymous'}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${medicine.donor ? `${medicine.donor.city || ''}, ${medicine.donor.state || ''}` : 'Location not available'}</span>
                                </div>
                                ${medicine.distanceFormatted ? 
                                    `<div class="distance-badge">
                                        <i class="fas fa-location-arrow"></i> ${medicine.distanceFormatted}
                                    </div>` : 
                                    medicine.distance ? 
                                    `<div class="distance-badge">
                                        <i class="fas fa-location-arrow"></i> ${medicine.distance.toFixed(1)} km
                                    </div>` : 
                                    `<div class="distance-badge">
                                        <i class="fas fa-location-arrow"></i> Distance unknown
                                    </div>`
                                }
                            </div>
                            <div class="card-actions">
                                <button class="action-button btn-details view-details" data-id="${medicine._id}">
                                    View Details
                                </button>
                                <button class="action-button btn-request" onclick="requestMedicine('${medicine._id}')">
                                    Request
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                medicinesGrid.innerHTML = medicinesHTML;
                
                // Re-attach event listeners
                attachEventListeners();
                updateDefaultImages();
            }
            
            // Update results count
            function updateResultsCount(count) {
                resultsCount.textContent = `${count} available medicines`;
            }
            

            
            // Clear filters function
            function clearFilters() {
                searchFilter.value = '';
                categoryFilter.value = '';
                distanceFilter.value = '50';
                customDistanceInput.value = '';
                customDistanceInput.style.display = 'none';
                sortFilter.value = 'distance';
                applyFilters();
            }
            
            // Attach event listeners to new elements
            function attachEventListeners() {
                // Re-attach view details buttons
                const viewButtons = document.querySelectorAll('.view-details');
                viewButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const medicineId = this.getAttribute('data-id');
                        openModal(medicineId);
                    });
                });
                
                // Re-attach modal close event listeners
                closeModal.addEventListener('click', closeModalFunc);
                closeModalBtn.addEventListener('click', closeModalFunc);
                
                // Close modal when clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeModalFunc();
                    }
                });
                
                // Request button functionality
                const requestButtons = document.querySelectorAll('.btn-request');
                requestButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const medicineId = this.getAttribute('data-id') || this.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                        if (medicineId) {
                            requestMedicine(medicineId);
                        }
                    });
                });
            }
            
            // Handle custom distance input visibility
            function handleDistanceFilterChange() {
                if (distanceFilter.value === 'custom') {
                    customDistanceInput.style.display = 'block';
                    customDistanceInput.focus();
                } else {
                    customDistanceInput.style.display = 'none';
                }
            }
            
            // Event listeners for filters
            searchFilter.addEventListener('input', debounceSearch);
            categoryFilter.addEventListener('change', applyFilters);
            distanceFilter.addEventListener('change', () => {
                handleDistanceFilterChange();
                applyFilters();
            });
            customDistanceInput.addEventListener('input', debounceSearch);
            sortFilter.addEventListener('change', applyFilters);
            clearFiltersBtn.addEventListener('click', clearFilters);
            
            // Make clearFilters globally available
            window.clearFilters = clearFilters;
            
            // Initialize custom distance input visibility
            handleDistanceFilterChange();
        });
        
        // Request medicine function
        async function requestMedicine(medicineId) {
            if (confirm('Are you sure you want to request this medicine? The donor will be notified.')) {
                try {
                    const response = await fetch(`/dashboard/request-medicine/${medicineId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            quantity: 1, // Default quantity, can be enhanced with a form
                            message: 'I would like to request this medicine.'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Request submitted successfully! The donor will contact you to arrange pickup.');
                        // Close modal if open
                        const modal = document.getElementById('medicineModal');
                        if (modal.classList.contains('active')) {
                            modal.classList.remove('active');
                            document.body.style.overflow = 'auto';
                        }
                        // Refresh the page after a short delay to show updated status
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Request error:', error);
                    alert('Error submitting request. Please try again.');
                }
            }
        }
    </script>
</div>