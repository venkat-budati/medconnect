<% title = 'Browse Medicines - MedConnect' %>

<link rel="stylesheet" href="/css/browse.css">

<!-- Browse Medicines Section -->
<div class="main-content">
    <div class="browse-container">
        <!-- Browse Header -->
        <div class="browse-header">
            <div>
                <h2 class="browse-title">Browse Available Medicines</h2>
                <p class="browse-subtitle">Find medicines donated by others near you</p>
            </div>
            <div class="results-count"><%= medicines ? medicines.length : 0 %> available medicines</div>
        </div>
        
        <!-- Filters -->
        <form class="filters-container" method="GET" action="/dashboard/browse">
            <div class="filter-group">
                <label class="filter-label">Medicine Name</label>
                <input type="text" class="filter-input" name="search" placeholder="Search by name" value="<%= currentFilters.search || '' %>">
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Category</label>
                <select class="filter-select" name="category">
                    <option value="">All Categories</option>
                    <% if (categories) { %>
                        <% categories.forEach(category => { %>
                            <option value="<%= category %>" <%= currentFilters.category === category ? 'selected' : '' %>><%= category %></option>
                        <% }); %>
                    <% } %>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Distance</label>
                <select class="filter-select" name="distance">
                    <option value="5" <%= currentFilters.distance === '5' ? 'selected' : '' %>>Within 5 miles</option>
                    <option value="10" <%= currentFilters.distance === '10' ? 'selected' : '' %>>Within 10 miles</option>
                    <option value="25" <%= currentFilters.distance === '25' ? 'selected' : '' %>>Within 25 miles</option>
                    <option value="50" <%= currentFilters.distance === '50' ? 'selected' : '' %>>Within 50 miles</option>
                    <option value="100" <%= currentFilters.distance === '100' ? 'selected' : '' %>>Any Distance</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Sort By</label>
                <select class="filter-select" name="sort">
                    <option value="distance" <%= currentFilters.sort === 'distance' ? 'selected' : '' %>>Distance</option>
                    <option value="newest" <%= currentFilters.sort === 'newest' ? 'selected' : '' %>>Newest First</option>
                    <option value="oldest" <%= currentFilters.sort === 'oldest' ? 'selected' : '' %>>Oldest First</option>
                    <option value="expiry" <%= currentFilters.sort === 'expiry' ? 'selected' : '' %>>Expiry Date</option>
                    <option value="name" <%= currentFilters.sort === 'name' ? 'selected' : '' %>>Name A-Z</option>
                </select>
            </div>
            
            <button type="submit" class="filter-button">
                <i class="fas fa-filter"></i> Apply Filters
            </button>
        </form>
        
        <!-- Location Notice -->
        <% if (!userLocation) { %>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div class="alert-content">
                    <h4>Location Required</h4>
                    <p>To see distance-based results, please update your profile with your complete address.</p>
                    <a href="/dashboard/profile" class="btn btn-primary">Update Profile</a>
                </div>
            </div>
        <% } %>
        
        <!-- Medicines Grid -->
        <div class="medicines-grid">
            <% if (medicines && medicines.length > 0) { %>
                <% medicines.forEach(medicine => { %>
                    <div class="medicine-card">
                        <div class="medicine-image">
                            <% if (medicine.imageUrl) { %>
                                <img src="<%= medicine.imageUrl %>" alt="<%= medicine.name %>">
                            <% } else { %>
                                <i class="fas fa-capsules"></i>
                            <% } %>
                            <div class="medicine-status status-<%= medicine.status.toLowerCase() %>"><%= medicine.status %></div>
                        </div>
                        <div class="medicine-details">
                            <h4 class="medicine-name"><%= medicine.name %></h4>
                            <div class="medicine-info">
                                <div class="info-item">
                                    <i class="fas fa-capsules"></i>
                                    <span><%= medicine.quantity %> <%= medicine.unit || 'tablets' %></span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>Expires: <%= new Date(medicine.expiry).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-user"></i>
                                    <span>Donated by: <%= medicine.donor ? (medicine.donor.firstName || medicine.donor.email.split('@')[0]) : 'Anonymous' %></span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span><%= medicine.donor ? `${medicine.donor.city || ''}, ${medicine.donor.state || ''}` : 'Location not available' %></span>
                                </div>
                                <% if (medicine.distanceFormatted) { %>
                                    <div class="distance-badge">
                                        <i class="fas fa-location-arrow"></i> <%= medicine.distanceFormatted %>
                                    </div>
                                <% } %>
                            </div>
                            <div class="card-actions">
                                <button class="action-button btn-details view-details" data-id="<%= medicine._id %>">
                                    View Details
                                </button>
                                <button class="action-button btn-request" onclick="requestMedicine('<%= medicine._id %>')">
                                    Request
                                </button>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="empty-state" style="grid-column: 1 / -1; grid-row: 1 / -1;">
                    <i class="fas fa-search"></i>
                    <h4>No medicines found</h4>
                    <p>Try adjusting your filters or check back later for new donations.</p>
                    <a href="/dashboard/browse" class="btn btn-primary">Clear Filters</a>
                </div>
            <% } %>
        </div>
    </div>
    
    <!-- Medicine Details Modal -->
    <div class="modal-overlay" id="medicineModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Medicine Details</h3>
                <button class="close-modal" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="modal-image">
                    <i class="fas fa-capsules" id="modalImage"></i>
                </div>
                <div class="modal-details">
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-capsules"></i> Medicine Name</span>
                        <span class="detail-value" id="medName"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-info-circle"></i> Description</span>
                        <span class="detail-value" id="medDesc"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-calculator"></i> Quantity</span>
                        <span class="detail-value" id="medQty"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-calendar"></i> Expiry Date</span>
                        <span class="detail-value" id="medExpiry"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-tag"></i> Category</span>
                        <span class="detail-value" id="medCategory"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-user"></i> Donated By</span>
                        <span class="detail-value" id="medDonor"></span>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-map-marker-alt"></i> Pickup Location</span>
                        <div class="address-card">
                            <div class="detail-value" id="medAddress"></div>
                        </div>
                    </div>
                    
                    <div class="detail-group">
                        <span class="detail-label"><i class="fas fa-clock"></i> Donated On</span>
                        <span class="detail-value" id="medDonatedOn"></span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="closeModalBtn">
                    Close
                </button>
                <button class="action-button btn-request" id="modalRequestBtn">
                    Request This Medicine
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('medicineModal');
            const closeModal = document.getElementById('closeModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const viewButtons = document.querySelectorAll('.btn-view');            
            // Medicine data from backend
            const medicines = <%- JSON.stringify(medicines || []) %>;
            
            // Open modal function
            function openModal(medicineId) {
                const medicine = medicines.find(m => m._id === medicineId);
                if (!medicine) return;
                
                // Update modal content
                document.getElementById('medName').textContent = medicine.name;
                document.getElementById('medDesc').textContent = medicine.description || 'No description available';
                document.getElementById('medQty').textContent = `${medicine.quantity} ${medicine.unit || 'tablets'}`;
                document.getElementById('medExpiry').textContent = new Date(medicine.expiry).toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                document.getElementById('medCategory').textContent = medicine.category || 'Uncategorized';
                document.getElementById('medDonor').textContent = medicine.donor ? 
                    (medicine.donor.firstName || medicine.donor.email.split('@')[0]) : 'Anonymous';
                document.getElementById('medDonatedOn').textContent = new Date(medicine.createdAt).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Address
                let address = 'Location not available';
                if (medicine.donor && medicine.donor.addressLine1) {
                    address = `${medicine.donor.addressLine1}`;
                    if (medicine.donor.city) address += `, ${medicine.donor.city}`;
                    if (medicine.donor.state) address += `, ${medicine.donor.state}`;
                    if (medicine.donor.pincode) address += ` ${medicine.donor.pincode}`;
                }
                document.getElementById('medAddress').textContent = address;
                
                // Set request button data
                document.getElementById('modalRequestBtn').setAttribute('data-id', medicineId);
                
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            // Close modal function
            function closeModalFunc() {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            // Event listeners
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const medicineId = this.getAttribute('data-id');
                    openModal(medicineId);
                });
            });
            
            closeModal.addEventListener('click', closeModalFunc);
            closeModalBtn.addEventListener('click', closeModalFunc);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModalFunc();
                }
            });
            
            // Request button functionality
            const requestButtons = document.querySelectorAll('.btn-request');
            requestButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const medicineId = this.getAttribute('data-id') || this.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                    if (medicineId) {
                        requestMedicine(medicineId);
                    }
                });
            });
        });
        
        // Request medicine function
        async function requestMedicine(medicineId) {
            if (confirm('Are you sure you want to request this medicine? The donor will be notified.')) {
                try {
                    const response = await fetch(`/dashboard/request-medicine/${medicineId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            quantity: 1, // Default quantity, can be enhanced with a form
                            message: 'I would like to request this medicine.'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Request submitted successfully! The donor will contact you to arrange pickup.');
                        // Close modal if open
                        const modal = document.getElementById('medicineModal');
                        if (modal.classList.contains('active')) {
                            modal.classList.remove('active');
                            document.body.style.overflow = 'auto';
                        }
                        // Refresh the page after a short delay to show updated status
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Request error:', error);
                    alert('Error submitting request. Please try again.');
                }
            }
        }
    </script>
</div>